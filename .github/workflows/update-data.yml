name: Update Economic Data with History (EMA Smoothed)

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Update economic data + history (EMA)
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          python3 << 'EOF'
import requests
import json
import os
from datetime import datetime

API_KEY = os.environ.get("FRED_API_KEY")
if not API_KEY:
    print("âŒ ERROR: FRED_API_KEY missing")
    exit(1)

print("âœ“ Using FRED API key")

# ------------------- Fetch function -------------------
def fetch(series_id):
    url = "https://api.stlouisfed.org/fred/series/observations"
    params = {
        "api_key": API_KEY,
        "series_id": series_id,
        "file_type": "json",
        "sort_order": "desc",
        "limit": 10
    }
    try:
        r = requests.get(url, params=params, timeout=10)
        if r.status_code != 200:
            print(f"âš  Warning: {series_id} bad response (status {r.status_code})")
            return None, None
        data = r.json().get("observations", [])
        for obs in data:
            if obs["value"] != ".":
                return obs["value"], obs["date"]
    except Exception as e:
        print(f"âš  Error fetching {series_id}: {e}")
    return None, None

# ------------------- Fetch all indicators -------------------
print("Fetching latest indicators...")

d10, date10 = fetch("DGS10")
d2, date2 = fetch("DGS2")
unemp, date_u = fetch("UNRATE")
claims, date_c = fetch("ICSA")
gdp, date_g = fetch("A191RL1Q225SBEA")
iprod, date_i = fetch("INDPRO")
sent, date_s = fetch("UMCSENT")
spread, date_b = fetch("BAMLC0A4CBBB")
hstart, date_h = fetch("HOUST")

print(f"10Y: {d10} ({date10}), 2Y: {d2} ({date2})")
print(f"Unemployment: {unemp} ({date_u})")
print(f"Claims: {claims} ({date_c})")
print(f"GDP: {gdp} ({date_g})")
print(f"Industrial Production: {iprod} ({date_i})")
print(f"Sentiment: {sent} ({date_s})")
print(f"BBB Spread: {spread} ({date_b})")
print(f"Housing Starts: {hstart} ({date_h})")

# ------------------- Compute yield curve -------------------
yc = None
if d10 and d2:
    try:
        yc = float(d10) - float(d2)
        print(f"Yield curve (10Y-2Y): {yc:.2f} pp")
    except Exception as e:
        print(f"âš  Error computing yield curve: {e}")

# ------------------- Risk Calculation -------------------
risk = 15  # baseline
print(f"Starting baseline risk: {risk}")

# Yield curve
if yc is not None:
    if yc < -0.5:
        risk += 25
        print(f"Yield curve deeply inverted (< -0.5): +25 â†’ {risk}")
    elif yc < 0:
        delta = abs(yc) * 30
        risk += delta
        print(f"Yield curve slightly inverted: +{delta:.1f} â†’ {risk}")
    elif yc > 0.5:
        risk -= 5
        print(f"Yield curve comfortably positive (> 0.5): -5 â†’ {risk}")

# Unemployment
if unemp:
    try:
        u = float(unemp)
        if u > 5:
            delta = (u - 5) * 8
            risk += delta
            print(f"Unemployment {u:.1f}% > 5%: +{delta:.1f} â†’ {risk}")
        elif u < 4:
            risk -= 3
            print(f"Unemployment {u:.1f}% < 4%: -3 â†’ {risk}")
    except Exception as e:
        print(f"âš  Error handling unemployment: {e}")

# Jobless claims
if claims:
    try:
        c = float(claims)
        if c > 300000:
            delta = (c - 300000) / 10000
            risk += delta
            print(f"Claims {c:.0f} > 300k: +{delta:.1f} â†’ {risk}")
    except Exception as e:
        print(f"âš  Error handling claims: {e}")

# GDP
if gdp:
    try:
        g = float(gdp)
        if g < 0:
            risk += 15
            print(f"GDP {g:.1f}% < 0: +15 â†’ {risk}")
        elif g < 2:
            delta = (2 - g) * 5
            risk += delta
            print(f"GDP {g:.1f}% < 2: +{delta:.1f} â†’ {risk}")
    except Exception as e:
        print(f"âš  Error handling GDP: {e}")

# Consumer sentiment
if sent:
    try:
        cs = float(sent)
        if cs < 70:
            risk += 10
            print(f"Sentiment {cs:.1f} < 70: +10 â†’ {risk}")
        elif cs < 90:
            delta = (90 - cs) / 4
            risk += delta
            print(f"Sentiment {cs:.1f} < 90: +{delta:.1f} â†’ {risk}")
    except Exception as e:
        print(f"âš  Error handling sentiment: {e}")

# Credit spread
if spread:
    try:
        s = float(spread)
        if s > 2.5:
            delta = (s - 2.5) * 8
            risk += delta
            print(f"Spread {s:.2f} > 2.5: +{delta:.1f} â†’ {risk}")
    except Exception as e:
        print(f"âš  Error handling spread: {e}")

# Clamp raw risk
risk = round(risk, 1)
risk = max(5, min(95, risk))
print(f"Raw (unsmoothed) risk for today: {risk}%")

# ------------------- Load existing history -------------------
try:
    with open("risk_history.json", "r") as f:
        hist = json.load(f)
    print(f"Loaded {len(hist)} existing history entries.")
except Exception as e:
    print(f"âš  Could not load risk_history.json ({e}); starting fresh.")
    hist = []

# ------------------- EMA Smoothing -------------------
def ema(values, alpha=0.2):
    if not values:
        return values
    smoothed = [values[0]]
    for v in values[1:]:
        smoothed.append(alpha * v + (1 - alpha) * smoothed[-1])
    return smoothed

today = datetime.now().strftime("%Y-%m-%d")

# Append today's raw value
hist.append({"date": today, "risk": risk})

# Keep only last 730 days
hist = hist[-730:]

raw_values = [h["risk"] for h in hist]
smoothed_values = ema(raw_values, alpha=0.2)

for i, v in enumerate(smoothed_values):
    hist[i]["risk"] = round(v, 1)

print(f"âœ“ EMA smoothing applied over {len(hist)} points.")
print(f"Latest smoothed risk: {hist[-1]['risk']}% on {hist[-1]['date']}")

# ------------------- Save updated history -------------------
with open("risk_history.json", "w") as f:
    json.dump(hist, f, indent=2)

print("âœ“ Saved risk_history.json")

# ------------------- Build current_indicators.json -------------------
current = {
    "generated_at": datetime.now().strftime("%Y-%m-%dT%H:%M:%S"),
    "risk": {
        "value": risk,
        "date": today
    },
    "indicators": [
        {
            "name": "Yield Curve (10Y-2Y)",
            "id": "yield_curve",
            "frequency": "Daily",
            "value": round(yc, 2) if yc is not None else None,
            "last_updated": min(date10, date2) if date10 and date2 else None
        },
        {
            "name": "Unemployment Rate",
            "id": "unemployment",
            "frequency": "Monthly",
            "value": float(unemp) if unemp else None,
            "last_updated": date_u
        },
        {
            "name": "Initial Jobless Claims",
            "id": "initial_claims",
            "frequency": "Weekly",
            "value": float(claims) if claims else None,
            "last_updated": date_c
        },
        {
            "name": "Real GDP Growth",
            "id": "gdp_growth",
            "frequency": "Quarterly",
            "value": float(gdp) if gdp else None,
            "last_updated": date_g
        },
        {
            "name": "Industrial Production",
            "id": "industrial_production",
            "frequency": "Monthly",
            "value": float(iprod) if iprod else None,
            "last_updated": date_i
        },
        {
            "name": "Consumer Sentiment",
            "id": "consumer_sentiment",
            "frequency": "Monthly",
            "value": float(sent) if sent else None,
            "last_updated": date_s
        },
        {
            "name": "BBB Corporate Credit Spread",
            "id": "bbb_credit_spread",
            "frequency": "Daily",
            "value": float(spread) if spread else None,
            "last_updated": date_b
        },
        {
            "name": "Housing Starts",
            "id": "housing_starts",
            "frequency": "Monthly",
            "value": float(hstart) if hstart else None,
            "last_updated": date_h
        }
    ]
}

with open("current_indicators.json", "w") as f:
    json.dump(current, f, indent=2)

print("âœ“ Saved current_indicators.json")

# ------------------- Update index.html (risk number) -------------------
try:
    with open("index.html", "r") as f:
        html = f.read()

    old = '<div class="risk-percentage" id="riskValue">â€”</div>'
    new = f'<div class="risk-percentage" id="riskValue">{risk}%</div>'
    if old in html:
        html = html.replace(old, new)
        with open("index.html", "w") as f:
            f.write(html)
        print("âœ“ Updated index.html risk placeholder")
    else:
        print("â„¹ risk placeholder not found in index.html; skipping HTML update.")
except Exception as e:
    print(f"âš  Could not update index.html: {e}")

print("ðŸŽ‰ DONE â€“ Workflow successful.")
EOF

      - name: Commit & push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git diff --quiet && git diff --staged --quiet || \
            (git commit -m "Automated update - $(date)" && git push)
