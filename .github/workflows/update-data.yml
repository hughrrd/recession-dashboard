name: Update Economic Data with History (EMA Smoothed)

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install requests

    - name: Update economic data, compute risk, and smooth history
      env:
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        import requests, json, os
        from datetime import datetime

        API_KEY = os.environ.get("FRED_API_KEY")
        if not API_KEY:
            print("ERROR: Missing FRED_API_KEY secret")
            exit(1)

        # ---------------------------
        # Helper: Fetch latest FRED value
        # ---------------------------
        def fetch_latest(series_id):
            url = "https://api.stlouisfed.org/fred/series/observations"
            params = {
                "series_id": series_id,
                "api_key": API_KEY,
                "file_type": "json",
                "sort_order": "desc",
                "limit": 10
            }
            try:
                r = requests.get(url, params=params, timeout=10)
                data = r.json()
                for obs in data["observations"]:
                    if obs["value"] != ".":
                        return float(obs["value"]), obs["date"]
            except Exception as e:
                print(f"Error fetching {series_id}: {e}")
            return None, None

        print("Fetching FRED data...")

        d10, d10_date = fetch_latest("DGS10")
        d02, d02_date = fetch_latest("DGS2")
        unrate, unrate_date = fetch_latest("UNRATE")
        claims, claims_date = fetch_latest("ICSA")
        gdp, gdp_date = fetch_latest("A191RL1Q225SBEA")
        indpro, indpro_date = fetch_latest("INDPRO")
        sentiment, sentiment_date = fetch_latest("UMCSENT")
        credit, credit_date = fetch_latest("BAMLC0A4CBBB")
        housing, housing_date = fetch_latest("HOUST")

        # ---------------------------
        # Compute Risk Score
        # ---------------------------
        risk = 15   # baseline

        # Yield curve
        if d10 is not None and d02 is not None:
            yc = d10 - d02
            if yc < -0.5:
                risk += 25
            elif yc < 0:
                risk += abs(yc) * 30
            elif yc > 0.5:
                risk -= 5
        else:
            yc = None

        # Unemployment
        if unrate is not None:
            if unrate > 5.0:
                risk += (unrate - 5.0) * 8
            elif unrate < 4.0:
                risk -= 3

        # Initial Claims
        if claims is not None and claims > 300000:
            risk += (claims - 300000) / 10000

        # GDP
        if gdp is not None:
            if gdp < 0:
                risk += 15
            elif gdp < 2.0:
                risk += (2.0 - gdp) * 5

        # Sentiment
        if sentiment is not None:
            if sentiment < 70:
                risk += 10
            elif sentiment < 90:
                risk += (90 - sentiment) / 4

        # Credit Spread
        if credit is not None and credit > 2.5:
            risk += (credit - 2.5) * 8

        # Bound risk
        risk = max(5, min(95, round(risk, 1)))

        print("Raw daily risk:", risk)

        # ---------------------------
        # Load existing history
        # ---------------------------
        try:
            with open("risk_history.json", "r") as f:
                history = json.load(f)
        except:
            history = []

        # New point for today
        today = datetime.utcnow().strftime("%Y-%m-%d")
        new_point = {"date": today, "risk": risk}

        # Replace if today's entry exists
        if history and history[-1]["date"] == today:
            history[-1] = new_point
        else:
            history.append(new_point)

        # Keep only last 2 years (~730 days)
        history = history[-730:]

        # ---------------------------
        # Apply EMA smoothing (Î± = 0.3)
        # ---------------------------
        alpha = 0.3
        smoothed = []
        ema_prev = history[0]["risk"]

        for entry in history:
            ema_today = alpha * entry["risk"] + (1 - alpha) * ema_prev
            ema_prev = ema_today
            smoothed.append({"date": entry["date"], "risk": round(ema_today, 2)})

        # Save smoothed history
        with open("risk_history.json", "w") as f:
            json.dump(smoothed, f, indent=2)

        print("Smoothed history updated.")

        # ---------------------------
        # Save current indicators JSON
        # ---------------------------
        indicators = {
            "generated_at": datetime.utcnow().isoformat(),
            "risk": {
                "value": risk,
                "date": today
            },
            "indicators": [
                {
                    "id": "yield_curve",
                    "name": "Yield Curve (10Y-2Y)",
                    "value": round(yc, 2) if yc is not None else None,
                    "frequency": "Daily",
                    "last_updated": min(d10_date, d02_date) if d10_date and d02_date else None
                },
                {
                    "id": "unemployment",
                    "name": "Unemployment Rate",
                    "value": unrate,
                    "frequency": "Monthly",
                    "last_updated": unrate_date
                },
                {
                    "id": "initial_claims",
                    "name": "Initial Jobless Claims",
                    "value": claims,
                    "frequency": "Weekly",
                    "last_updated": claims_date
                },
                {
                    "id": "gdp_growth",
                    "name": "Real GDP Growth",
                    "value": gdp,
                    "frequency": "Quarterly",
                    "last_updated": gdp_date
                },
                {
                    "id": "industrial_production",
                    "name": "Industrial Production",
                    "value": indpro,
                    "frequency": "Monthly",
                    "last_updated": indpro_date
                },
                {
                    "id": "consumer_sentiment",
                    "name": "Consumer Sentiment",
                    "value": sentiment,
                    "frequency": "Monthly",
                    "last_updated": sentiment_date
                },
                {
                    "id": "bbb_credit_spread",
                    "name": "BBB Credit Spread",
                    "value": credit,
                    "frequency": "Daily",
                    "last_updated": credit_date
                },
                {
                    "id": "housing_starts",
                    "name": "Housing Starts",
                    "value": housing,
                    "frequency": "Monthly",
                    "last_updated": housing_date
                }
            ]
        }

        with open("current_indicators.json", "w") as f:
            json.dump(indicators, f, indent=2)

        print("current_indicators.json updated.")

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --quiet || git commit -m "Daily data update (EMA smoothed)"
        git push
