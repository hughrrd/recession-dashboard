name: Update Economic Data with History (EMA Smoothed)

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install requests

    - name: Update economic data + history (EMA)
      env:
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        python3 << 'EOF'
import requests
import json
import os
from datetime import datetime

API_KEY = os.environ.get("FRED_API_KEY")
if not API_KEY:
    print("âŒ ERROR: FRED_API_KEY missing")
    exit(1)

print("âœ“ Using FRED API key")

# ------------------- Fetch function -------------------
def fetch(series_id):
    url = "https://api.stlouisfed.org/fred/series/observations"
    params = {
        "api_key": API_KEY,
        "series_id": series_id,
        "file_type": "json",
        "sort_order": "desc",
        "limit": 10
    }
    try:
        r = requests.get(url, params=params, timeout=10)
        if r.status_code != 200:
            print(f"âš  Warning: {series_id} bad response")
            return None, None
        data = r.json().get("observations", [])
        for obs in data:
            if obs["value"] != ".":
                return obs["value"], obs["date"]
    except Exception as e:
        print(f"âš  Error fetching {series_id}: {e}")
    return None, None

# ------------------- Fetch all indicators -------------------
print("Fetching latest indicators...")

d10, date10 = fetch("DGS10")
d2, date2 = fetch("DGS2")
unemp, date_u = fetch("UNRATE")
claims, date_c = fetch("ICSA")
gdp, date_g = fetch("A191RL1Q225SBEA")
iprod, date_i = fetch("INDPRO")
sent, date_s = fetch("UMCSENT")
spread, date_b = fetch("BAMLC0A4CBBB")
hstart, date_h = fetch("HOUST")

# ------------------- Compute yield curve -------------------
yc = None
if d10 and d2:
    yc = float(d10) - float(d2)

# ------------------- Risk Calculation -------------------
risk = 15  # baseline

# Yield curve
if yc is not None:
    if yc < -0.5:
        risk += 25
    elif yc < 0:
        risk += abs(yc) * 30
    elif yc > 0.5:
        risk -= 5

# Unemployment
if unemp:
    u = float(unemp)
    if u > 5: risk += (u - 5) * 8
    elif u < 4: risk -= 3

# Jobless claims
if claims:
    c = float(claims)
    if c > 300000:
        risk += (c - 300000) / 10000

# GDP
if gdp:
    g = float(gdp)
    if g < 0:
        risk += 15
    elif g < 2:
        risk += (2 - g) * 5

# Consumer sentiment
if sent:
    cs = float(sent)
    if cs < 70:
        risk += 10
    elif cs < 90:
        risk += (90 - cs) / 4

# Credit spread
if spread:
    s = float(spread)
    if s > 2.5:
        risk += (s - 2.5) * 8

# Clamp risk
risk = max(5, min(95, round(risk, 1)))

print(f"Raw risk: {risk}")

# ------------------- Load existing history -------------------
try:
    with open("risk_history.json", "r") as f:
        hist = json.load(f)
except:
    print("âš  No history found; initializing new list.")
    hist = []

# ------------------- EMA Smoothing -------------------
def ema(values, alpha=0.2):
    if not values:
        return values
    smoothed = [values[0]]
    for v in values[1:]:
        smoothed.append(alpha * v + (1 - alpha) * smoothed[-1])
    return smoothed

# Add today's raw value first
today = datetime.now().strftime("%Y-%m-%d")
hist.append({"date": today, "risk": risk})

# Keep last 730 days
hist = hist[-730:]

# Extract raw list
raw_values = [h["risk"] for h in hist]

# Smooth
smoothed = ema(raw_values)

# Write back smoothed values
for i, v in enumerate(smoothed):
    hist[i]["risk"] = round(v, 1)

print("âœ“ EMA smoothing applied")

# ------------------- Save updated history -------------------
with open("risk_history.json", "w") as f:
    json.dump(hist, f, indent=2)

print("âœ“ Saved risk_history.json")

# ------------------- Build current_indicators.json -------------------
current = {
    "generated_at": datetime.now().strftime("%Y-%m-%dT%H:%M:%S"),
    "risk": {
        "value": risk,
        "date": today
    },
    "indicators": [
        {
            "name": "Yield Curve (10Y-2Y)",
            "id": "yield_curve",
            "frequency": "Daily",
            "value": round(yc, 2) if yc is not None else None,
            "last_updated": min(date10, date2)
        },
        {
            "name": "Unemployment Rate",
            "id": "unemployment",
            "frequency": "Monthly",
            "value": float(unemp) if unemp else None,
            "last_updated": date_u
        },
        {
            "name": "Initial Jobless Claims",
            "id": "initial_claims",
            "frequency": "Weekly",
            "value": float(claims) if claims else None,
            "last_updated": date_c
        },
        {
            "name": "GDP Growth",
            "id": "gdp_growth",
            "frequency": "Quarterly",
            "value": float(gdp) if gdp else None,
            "last_updated": date_g
        },
        {
            "name": "Industrial Production",
            "id": "industrial_production",
            "frequency": "Monthly",
            "value": float(iprod) if iprod else None,
            "last_updated": date_i
        },
        {
            "name": "Consumer Sentiment",
            "id": "consumer_sentiment",
            "frequency": "Monthly",
            "value": float(sent) if sent else None,
            "last_updated": date_s
        },
        {
            "name": "BBB Corporate Credit Spread",
            "id": "bbb_credit_spread",
            "frequency": "Daily",
            "value": float(spread) if spread else None,
            "last_updated": date_b
        },
        {
            "name": "Housing Starts",
            "id": "housing_starts",
            "frequency": "Monthly",
            "value": float(hstart) if hstart else None,
            "last_updated": date_h
        }
    ]
}

with open("current_indicators.json", "w") as f:
    json.dump(current, f, indent=2)

print("âœ“ Saved current_indicators.json")

# ------------------- Update index.html -------------------
with open("index.html", "r") as f:
    html = f.read()

html = html.replace(
    '<div class="risk-percentage">â€”</div>',
    f'<div class="risk-percentage">{risk}%</div>'
)

with open("index.html", "w") as f:
    f.write(html)

print("âœ“ Updated index.html")

print("ðŸŽ‰ DONE â€“ Workflow successful.")
EOF

    - name: Commit & push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --quiet && git diff --staged --quiet || \
          (git commit -m "Automated update - $(date)" && git push)
