name: Update Economic Data

on:
  schedule:
    # Runs every day at 9 AM UTC (adjust timezone as needed)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Fetch data and update HTML
      env:
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        python << 'PYTHON_SCRIPT'
        import requests
        import json
        import re
        from datetime import datetime

        # Your FRED API key from GitHub Secrets
        import os
        API_KEY = os.environ.get('FRED_API_KEY')

        if not API_KEY:
            print("ERROR: FRED_API_KEY not found in secrets!")
            exit(1)

        # FRED series IDs to fetch
        series_mapping = {
            'yieldCurve': 'T10Y2Y',
            'unemployment': 'UNRATE',
            'initialClaims': 'ICSA',
            'gdpGrowth': 'A191RL1Q225SBEA',
            'industrialProduction': 'INDPRO',
            'consumerSentiment': 'UMCSENT',
            'creditSpread': 'BAMLC0A4CBBB',
            'housingStarts': 'HOUST'
        }

        # Fetch data from FRED with date
        def fetch_fred_data(series_id):
            url = f"https://api.stlouisfed.org/fred/series/observations"
            params = {
                'series_id': series_id,
                'api_key': API_KEY,
                'file_type': 'json',
                'limit': 1,
                'sort_order': 'desc'
            }
            try:
                response = requests.get(url, params=params, timeout=10)
                response.raise_for_status()
                data = response.json()
                if data.get('observations') and len(data['observations']) > 0:
                    obs = data['observations'][0]
                    value = obs['value']
                    date = obs['date']
                    
                    # Handle special cases where value is '.'
                    if value == '.':
                        return None, None
                    
                    try:
                        return float(value), date
                    except (ValueError, TypeError):
                        return None, None
                return None, None
            except Exception as e:
                print(f"Error fetching {series_id}: {e}")
                return None, None

        # Fetch all data
        print("Fetching data from FRED API...")
        economic_data = {}
        date_data = {}
        
        for key, series_id in series_mapping.items():
            value, date = fetch_fred_data(series_id)
            if value is not None:
                economic_data[key] = value
                date_data[key] = date
                print(f"âœ“ {key}: {value} (as of {date})")
            else:
                print(f"âœ— {key}: Failed to fetch")

        if not economic_data:
            print("ERROR: No data fetched successfully!")
            exit(1)

        # Read the current HTML file
        try:
            with open('index.html', 'r', encoding='utf-8') as f:
                html_content = f.read()
        except FileNotFoundError:
            print("ERROR: index.html not found!")
            exit(1)

        # Format dates for display
        def format_date(date_str):
            """Convert YYYY-MM-DD to readable format like 'Nov 19, 2025'"""
            try:
                date_obj = datetime.strptime(date_str, '%Y-%m-%d')
                return date_obj.strftime('%b %d, %Y')
            except:
                return date_str

        # Update the currentEconomicData object
        pattern = r'const currentEconomicData = \{[^}]+\};'
        
        new_data = f"""const currentEconomicData = {{
            yieldCurve: {economic_data.get('yieldCurve', 0.44)},
            unemployment: {economic_data.get('unemployment', 4.1)},
            initialClaims: {economic_data.get('initialClaims', 213000)},
            gdpGrowth: {economic_data.get('gdpGrowth', 2.8)},
            industrialProduction: {economic_data.get('industrialProduction', 0.2)},
            consumerSentiment: {economic_data.get('consumerSentiment', 111.7)},
            creditSpread: {economic_data.get('creditSpread', 1.95)},
            housingStarts: {economic_data.get('housingStarts', 1354)}
        }};"""

        html_content = re.sub(pattern, new_data, html_content)

        # Update the lastUpdatedDates object (create if doesn't exist)
        dates_pattern = r'const lastUpdatedDates = \{[^}]+\};'
        
        new_dates = f"""const lastUpdatedDates = {{
            yieldCurve: '{format_date(date_data.get('yieldCurve', ''))}',
            unemployment: '{format_date(date_data.get('unemployment', ''))}',
            initialClaims: '{format_date(date_data.get('initialClaims', ''))}',
            gdpGrowth: '{format_date(date_data.get('gdpGrowth', ''))}',
            industrialProduction: '{format_date(date_data.get('industrialProduction', ''))}',
            consumerSentiment: '{format_date(date_data.get('consumerSentiment', ''))}',
            creditSpread: '{format_date(date_data.get('creditSpread', ''))}',
            housingStarts: '{format_date(date_data.get('housingStarts', ''))}'
        }};"""

        # Check if lastUpdatedDates exists in the file
        if 'const lastUpdatedDates' in html_content:
            # Update existing
            html_content = re.sub(dates_pattern, new_dates, html_content)
        else:
            # Insert after currentEconomicData
            insert_pattern = r'(const currentEconomicData = \{[^}]+\};)'
            html_content = re.sub(insert_pattern, r'\1\n        \n        ' + new_dates, html_content)

        # Write the updated HTML back
        with open('index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)

        current_time = datetime.utcnow().strftime('%B %d, %Y at %H:%M UTC')
        print(f"\nâœ… Successfully updated index.html with latest data!")
        print(f"ðŸ“… Update time: {current_time}")
        
        PYTHON_SCRIPT
        
    - name: Commit and push if changed
      run: |
        git config --global user.name 'Economic Data Bot'
        git config --global user.email 'bot@github-actions'
        git add index.html
        git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update economic data - $(date +'%Y-%m-%d %H:%M UTC')" && git push)
