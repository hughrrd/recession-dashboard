name: Update Economic Data

on:
  schedule:
    # Runs every day at 9 AM UTC (adjust timezone as needed)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Fetch data and update HTML
      env:
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        python << 'PYTHON_SCRIPT'
        import requests
        import json
        import re
        from datetime import datetime

        # Your FRED API key from GitHub Secrets
        import os
        API_KEY = os.environ.get('FRED_API_KEY')

        if not API_KEY:
            print("ERROR: FRED_API_KEY not found in secrets!")
            exit(1)

        # FRED series IDs to fetch
        series_ids = {
            'yieldCurve': 'T10Y2Y',
            'unemployment': 'UNRATE',
            'initialClaims': 'ICSA',
            'gdpGrowth': 'A191RL1Q225SBEA',
            'industrialProduction': 'INDPRO',
            'consumerSentiment': 'UMCSENT',
            'creditSpread': 'BAMLC0A4CBBB',
            'housingStarts': 'HOUST'
        }

        # Fetch data from FRED
        def fetch_fred_data(series_id):
            url = f"https://api.stlouisfed.org/fred/series/observations"
            params = {
                'series_id': series_id,
                'api_key': API_KEY,
                'file_type': 'json',
                'limit': 1,
                'sort_order': 'desc'
            }
            try:
                response = requests.get(url, params=params, timeout=10)
                response.raise_for_status()
                data = response.json()
                if data.get('observations') and len(data['observations']) > 0:
                    value = data['observations'][0]['value']
                    # Handle special cases
                    if value == '.':
                        return None
                    return float(value)
                return None
            except Exception as e:
                print(f"Error fetching {series_id}: {e}")
                return None

        # Calculate industrial production change (need 2 months of data)
        def fetch_indpro_change():
            url = f"https://api.stlouisfed.org/fred/series/observations"
            params = {
                'series_id': 'INDPRO',
                'api_key': API_KEY,
                'file_type': 'json',
                'limit': 2,
                'sort_order': 'desc'
            }
            try:
                response = requests.get(url, params=params, timeout=10)
                response.raise_for_status()
                data = response.json()
                if data.get('observations') and len(data['observations']) >= 2:
                    current = float(data['observations'][0]['value'])
                    previous = float(data['observations'][1]['value'])
                    change = ((current - previous) / previous) * 100
                    return round(change, 2)
                return 0.2  # Default fallback
            except Exception as e:
                print(f"Error calculating INDPRO change: {e}")
                return 0.2

        print("Fetching data from FRED API...")
        
        # Fetch all data
        economic_data = {}
        for key, series_id in series_ids.items():
            if key == 'industrialProduction':
                value = fetch_indpro_change()
            else:
                value = fetch_fred_data(series_id)
            
            if value is not None:
                economic_data[key] = value
                print(f"âœ“ {key}: {value}")
            else:
                print(f"âœ— {key}: Failed to fetch, using default")
                # Set defaults if fetch fails
                defaults = {
                    'yieldCurve': 0.44,
                    'unemployment': 4.3,
                    'initialClaims': 225000,
                    'gdpGrowth': 2.83,
                    'industrialProduction': 0.2,
                    'consumerSentiment': 71.8,
                    'creditSpread': 1.95,
                    'housingStarts': 1354
                }
                economic_data[key] = defaults.get(key, 0)

        # Read the HTML file
        try:
            with open('index.html', 'r', encoding='utf-8') as f:
                html_content = f.read()
        except FileNotFoundError:
            print("ERROR: index.html not found!")
            exit(1)

        # Update the data in the HTML
        # Find the currentEconomicData object and replace it
        pattern = r'const currentEconomicData = \{[^}]+\};'
        
        new_data = f"""const currentEconomicData = {{
            yieldCurve: {economic_data.get('yieldCurve', 0.44)},          // 10Y-2Y spread
            unemployment: {economic_data.get('unemployment', 4.3)},          // Latest unemployment rate
            initialClaims: {economic_data.get('initialClaims', 225000)},      // Weekly initial claims
            gdpGrowth: {economic_data.get('gdpGrowth', 2.83)},           // Latest GDP growth
            industrialProduction: {economic_data.get('industrialProduction', 0.2)},  // Monthly change %
            consumerSentiment: {economic_data.get('consumerSentiment', 71.8)},    // Michigan sentiment index
            creditSpread: {economic_data.get('creditSpread', 1.95)},         // BBB spread
            housingStarts: {economic_data.get('housingStarts', 1354)}        // Housing starts (thousands)
        }};"""

        html_content = re.sub(pattern, new_data, html_content)

        # Update the "last updated" text to include actual update time
        current_time = datetime.utcnow().strftime('%B %d, %Y at %H:%M UTC')
        
        # Write the updated HTML back
        with open('index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)

        print(f"\nâœ… Successfully updated index.html with latest data!")
        print(f"ðŸ“… Update time: {current_time}")
        
        PYTHON_SCRIPT
        
    - name: Commit and push if changed
      run: |
        git config --global user.name 'Economic Data Bot'
        git config --global user.email 'bot@github-actions'
        git add index.html
        git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update economic data - $(date +'%Y-%m-%d %H:%M UTC')" && git push)
