name: Update Economic Data with History

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Update economic data and history
      env:
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        python << 'EOF'
        import requests
        import json
        import re
        import os
        from datetime import datetime, timedelta

        API_KEY = os.environ.get('FRED_API_KEY')

        if not API_KEY:
            print("ERROR: FRED_API_KEY not found!")
            exit(1)

        # Series configuration
        SERIES_IDS = {
            'yieldCurve': 'T10Y2Y',
            'unemployment': 'UNRATE',
            'initialClaims': 'ICSA',
            'gdpGrowth': 'A191RL1Q225SBEA',
            'industrialProduction': 'IPG',
            'consumerSentiment': 'UMCSENT',
            'creditSpread': 'BAMLC0A4CBBB',
            'housingStarts': 'HOUST'
        }

        WEIGHTS = {
            'yieldCurve': 0.20,
            'unemployment': 0.18,
            'industrialProduction': 0.16,
            'creditSpread': 0.14,
            'gdpGrowth': 0.12,
            'housingStarts': 0.10,
            'initialClaims': 0.06,
            'consumerSentiment': 0.04
        }

        THRESHOLDS = {
            'yieldCurve': {'critical': -0.5, 'warning': 0, 'safe': 0.5, 'inverted': False},
            'unemployment': {'critical': 5.0, 'warning': 4.5, 'safe': 4.0, 'inverted': False},
            'initialClaims': {'critical': 350000, 'warning': 275000, 'safe': 225000, 'inverted': False},
            'gdpGrowth': {'critical': 0, 'warning': 1.5, 'safe': 2.5, 'inverted': True},
            'industrialProduction': {'critical': -1, 'warning': 0, 'safe': 0.5, 'inverted': True},
            'consumerSentiment': {'critical': 80, 'warning': 90, 'safe': 100, 'inverted': True},
            'creditSpread': {'critical': 3.0, 'warning': 2.0, 'safe': 1.5, 'inverted': False},
            'housingStarts': {'critical': 1000, 'warning': 1200, 'safe': 1400, 'inverted': True}
        }

        def fetch_fred_data(series_id):
            """Fetch latest data point from FRED."""
            url = f"https://api.stlouisfed.org/fred/series/observations"
            params = {
                'series_id': series_id,
                'api_key': API_KEY,
                'file_type': 'json',
                'limit': 10,
                'sort_order': 'desc'
            }
            try:
                response = requests.get(url, params=params, timeout=10)
                response.raise_for_status()
                data = response.json()
                
                if data.get('observations'):
                    for obs in data['observations']:
                        if obs['value'] != '.':
                            try:
                                return float(obs['value']), obs['date']
                            except (ValueError, TypeError):
                                continue
                return None, None
            except Exception as e:
                print(f"Error fetching {series_id}: {e}")
                return None, None

        def calculate_indicator_score(value, indicator_id):
            """Calculate risk score (0-100) for an indicator."""
            thresholds = THRESHOLDS[indicator_id]
            is_inverted = thresholds['inverted']
            
            if is_inverted:
                if value >= thresholds['safe']:
                    return 0
                elif value >= thresholds['warning']:
                    return 30
                elif value >= thresholds['critical']:
                    return 60
                else:
                    return 90
            else:
                if value <= thresholds['safe']:
                    return 0
                elif value <= thresholds['warning']:
                    return 30
                elif value <= thresholds['critical']:
                    return 60
                else:
                    return 90

        def format_date(date_str):
            """Convert YYYY-MM-DD to readable format."""
            try:
                date_obj = datetime.strptime(date_str, '%Y-%m-%d')
                return date_obj.strftime('%b %d, %Y')
            except:
                return date_str

        print("=" * 70)
        print("FETCHING CURRENT ECONOMIC DATA")
        print("=" * 70)
        
        # Fetch current data
        economic_data = {}
        date_data = {}
        
        for key, series_id in SERIES_IDS.items():
            value, date = fetch_fred_data(series_id)
            if value is not None:
                economic_data[key] = value
                date_data[key] = date
                print(f"âœ“ {key:25s} = {value:12.2f} (as of {date})")
            else:
                print(f"âœ— {key:25s} = FAILED")

        if not economic_data:
            print("ERROR: No data fetched!")
            exit(1)

        # Calculate current risk
        total_risk = 0
        for key, value in economic_data.items():
            score = calculate_indicator_score(value, key)
            weight = WEIGHTS[key]
            total_risk += score * weight

        current_risk = round(total_risk, 1)
        print(f"\nðŸ“Š Current recession risk: {current_risk}%")

        # Load or create risk history
        history_file = 'risk_history.json'
        if os.path.exists(history_file):
            with open(history_file, 'r') as f:
                risk_history = json.load(f)
            print(f"\nâœ“ Loaded {len(risk_history)} historical records")
        else:
            risk_history = []
            print("\nâš ï¸  No history file found, creating new one")

        # Add today's data to history
        today = datetime.now().strftime('%Y-%m-%d')
        
        # Check if today already exists
        today_exists = any(entry['date'] == today for entry in risk_history)
        
        if not today_exists:
            risk_history.append({
                'date': today,
                'risk': current_risk,
                'indicators': {k: round(v, 2) for k, v in economic_data.items()}
            })
            print(f"âœ“ Added today's risk ({current_risk}%) to history")
        else:
            # Update today's entry
            for entry in risk_history:
                if entry['date'] == today:
                    entry['risk'] = current_risk
                    entry['indicators'] = {k: round(v, 2) for k, v in economic_data.items()}
            print(f"âœ“ Updated today's risk to {current_risk}%")

        # Keep only last 730 days (2 years)
        risk_history = sorted(risk_history, key=lambda x: x['date'])[-730:]

        # Save updated history
        with open(history_file, 'w') as f:
            json.dump(risk_history, f, indent=2)
        print(f"âœ“ Saved {len(risk_history)} records to {history_file}")

        # Update HTML file
        print("\n" + "=" * 70)
        print("UPDATING HTML")
        print("=" * 70)
        
        with open('index.html', 'r', encoding='utf-8') as f:
            html_content = f.read()

        # Update currentEconomicData
        pattern = r'const currentEconomicData = \{[^}]+\};'
        new_data = f"""const currentEconomicData = {{
    yieldCurve: {economic_data.get('yieldCurve', 0.44)},
    unemployment: {economic_data.get('unemployment', 4.1)},
    initialClaims: {economic_data.get('initialClaims', 213000)},
    gdpGrowth: {economic_data.get('gdpGrowth', 2.8)},
    industrialProduction: {economic_data.get('industrialProduction', 0.2)},
    consumerSentiment: {economic_data.get('consumerSentiment', 111.7)},
    creditSpread: {economic_data.get('creditSpread', 1.95)},
    housingStarts: {economic_data.get('housingStarts', 1354)}
}};"""
        html_content = re.sub(pattern, new_data, html_content)

        # Update lastUpdatedDates
        dates_pattern = r'const lastUpdatedDates = \{[^}]+\};'
        new_dates = f"""const lastUpdatedDates = {{
    yieldCurve: '{format_date(date_data.get('yieldCurve', ''))}',
    unemployment: '{format_date(date_data.get('unemployment', ''))}',
    initialClaims: '{format_date(date_data.get('initialClaims', ''))}',
    gdpGrowth: '{format_date(date_data.get('gdpGrowth', ''))}',
    industrialProduction: '{format_date(date_data.get('industrialProduction', ''))}',
    consumerSentiment: '{format_date(date_data.get('consumerSentiment', ''))}',
    creditSpread: '{format_date(date_data.get('creditSpread', ''))}',
    housingStarts: '{format_date(date_data.get('housingStarts', ''))}'
}};"""

        if 'const lastUpdatedDates' in html_content:
            html_content = re.sub(dates_pattern, new_dates, html_content)
        else:
            insert_pattern = r'(const currentEconomicData = \{[^}]+\};)'
            html_content = re.sub(insert_pattern, r'\1\n        \n        ' + new_dates, html_content)

        with open('index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)

        print("âœ“ Updated index.html")
        print("\n" + "=" * 70)
        print(f"âœ… Update complete! Risk: {current_risk}%")
        print("=" * 70)
        
        EOF
        
    - name: Commit and push changes
      run: |
        git config --global user.name 'Economic Data Bot'
        git config --global user.email 'bot@github-actions'
        git add index.html risk_history.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update: Risk - $(date +'%Y-%m-%d %H:%M UTC')" && git push)
